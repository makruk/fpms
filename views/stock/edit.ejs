<div class="container">
<h1>Edit Stock</h1>
<form action="" method="post" onsubmit="return confirm();" id="edit_stock">
  <fieldset>
	<label>商品名</label><div class="input-control text"><input type="text" value="<%= stock.name %>" name="name" class="size6 validate[required]"></div>
	<label>カテゴリ</label><div class="input-control text"><input type="text" value="<%= stock.category %>" name="category"　autocomplete="on" list="cat" class="size6 validate[required]"></div>
<datalist id="cat">
<% for(var i=0;i<category.length;i++){ %>
<option value="<%= category[i].name %>">
<% } %>
</datalist>
	<label>仕入れ値</label><div class="input-control text"><input type="text" value="<%= stock.buy_price %>" name="buy_price" class="size6 validate[required,custom[integer],min[1]]"></div>
	<label>販売価格</label><div class="input-control text"><input type="text" value="<%= stock.price %>" name="price" class="size6 validate[required,custom[integer],min[1]]"></div>
  <canvas id="photo" width="300" height="250" style="border:solid 1px black;cursor:move"></canvas>
  <div><input type="range" width="300" max="100" min="1" step="1" id="scale" style="cursor:e-resize"></div>
  <input type="hidden" id="base64" name="base64">
  <label>画像のアップロード</label><div class="input-control"><input type="file" name="file" id="file"></div>
    <div>
		<input type="submit" value="確認" class = "button large info">
	&nbsp;&nbsp;
		<input type="button" value="キャンセル" onClick="location.href='/stock/<%= stock.id %>/'" class = "button large">
    </div>
  </fieldset>
</form>
<script>
jQuery(document).ready(function(){
  (function(){
    var scale=document.getElementById("scale");
    var img=new Image();
    var cvs=document.getElementById('photo');
    var ctx=cvs.getContext('2d');
    var offsetX=0, offsetY=0;
    var mx=0, my=0, stat=false;
    var previousImage=new Image();
    previousImage.onload=function(){
      ctx.drawImage(previousImage, 0, 0);
      img=previousImage;
      scale.value=25;
    };
    previousImage.onerror=function(){
      ctx.font='20px Segoe UI Light_, Open Sans Light, Verdana, Arial, Helvetica, sans-serif';
      ctx.fillText("Image will visible here.", 50, 100);
      ctx.fillText("Image is draggable and scalable.", 20, 150);
    };
    previousImage.src="/photos/<%= stock.id %>.png";
    var draw=function(){
      w=img.width*(scale.value/50)*2;
      h=img.height*(scale.value/50)*2;
      ctx.clearRect(0, 0, cvs.width, cvs.height);
      ctx.drawImage(img, offsetX, offsetY, w, h);
    }
    scale.oninput=function(){
      draw();
    };
    cvs.addEventListener("mousedown", function(e){
      mx=e.screenX;
      my=e.screenY;
      stat=true;
    }, false);
    document.addEventListener("mousemove", function(e){
      if(stat){
        w=img.width*(scale.value/50)*2;
        h=img.height*(scale.value/50)*2;
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        ctx.drawImage(img, offsetX+e.screenX-mx, offsetY+e.screenY-my, w, h);
      }
    });
    document.addEventListener("mouseup", function(e){
      if(stat){
        offsetX+=(e.screenX-mx);
        offsetY+=(e.screenY-my);
        draw();
      }
      stat=false;
    }, false);
    $("#file").change(function(){
      if(window.File){
        var reader=new FileReader();
        var file=$("#file").prop("files")[0];
        reader.readAsDataURL(file);
        reader.onload=function(e){
          img.src=reader.result;
          img.onload=function(){

            draw();
          }
        };
      }
    });
  })();
  jQuery("#edit_stock").validationEngine();
});
  var isConfirmDisplayed=false;
  var confirm=function(){
    $("#base64").val(document.getElementById('photo').toDataURL());
    var name="<dt>商品名</dt><dd>"+$('#edit_stock input[name="name"]').val()+"</dd>";
    var category="<dt>カテゴリ</dt><dd>"+$('#edit_stock input[name="category"]').val()+"</dd>";
    var buy_price="<dt>仕入れ値</dt><dd>"+$('#edit_stock input[name="buy_price"]').val()+"</dd>";
    var price="<dt>販売価格</dt><dd>"+$('#edit_stock input[name="price"]').val()+"</dd>";
    if(!isConfirmDisplayed){
      $.Dialog({
          shadow: true,
          overlay: false,
          icon: '<span class="icon-rocket"></span>',
          title: '変更確認',
          width: 500,
          padding: 10,
          content: '<p>以下の内容で変更します。よろしいですか?</p><dl>'+name+category+buy_price+price+'</dl><button class="large info" onclick="$(\'#edit_stock\').submit();">OK</button><button class="large" onclick="$.Dialog.close()">キャンセル</button>',
          onShow:function(){isConfirmDisplayed=true;},
      });
      $.Dialog.close=(function(){
        var context=$.Dialog;
        var origin=$.Dialog.close;
        return (function(){isConfirmDisplayed=false;origin.call(context);});
      })();
      return false;
    }
  }
</script>
</div>
